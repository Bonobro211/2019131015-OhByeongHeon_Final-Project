import random, urllib.request, ipywidgets as w
from IPython.display import display

# â”€â”€ ì´ë¯¸ì§€ URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
URLS = {
    'ê°€ìœ„': 'https://github.com/Bonobro211/Rock-Scissors-Paper/blob/main/%EA%B0%80%EC%9C%84.png?raw=true',
    'ë°”ìœ„': 'https://github.com/Bonobro211/Rock-Scissors-Paper/blob/main/%EB%B0%94%EC%9C%84.png?raw=true',
    'ë³´'  : 'https://github.com/Bonobro211/Rock-Scissors-Paper/blob/main/%EB%B3%B4.png?raw=true'
}

# â”€â”€ URL â†’ ë°”ì´íŠ¸ ë¡œë”© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
IMG_BYTES = {k: urllib.request.urlopen(u).read() for k, u in URLS.items()}

# â”€â”€ AI í…Œì´ë¸” (ì–´ë ¤ì›€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
C1 = ('ê°€ìœ„', 'ë°”ìœ„'); C2 = ('ê°€ìœ„', 'ë³´'); C3 = ('ë°”ìœ„', 'ë³´')
AI_TABLE = {
    (C1, C1): {'ë°”ìœ„': 1.0},
    (C2, C2): {'ê°€ìœ„': 1.0},
    (C3, C3): {'ë³´':   1.0},
    (C3, C1): {'ë°”ìœ„': 0.7, 'ë³´': 0.3},
    (C2, C1): {'ë³´':   0.7, 'ê°€ìœ„': 0.3},
    (C1, C3): {'ê°€ìœ„': 0.7, 'ë°”ìœ„': 0.3},
    (C2, C3): {'ë³´':   0.7, 'ê°€ìœ„': 0.3},
    (C1, C2): {'ê°€ìœ„': 0.7, 'ë°”ìœ„': 0.3},
    (C3, C2): {'ë°”ìœ„': 0.7, 'ë³´': 0.3},
}
def choose_hard(comp_two, player_two):
    key = (tuple(sorted(comp_two)), tuple(sorted(player_two)))
    probs = AI_TABLE[key]
    hands, weights = zip(*probs.items())
    return random.choices(hands, weights)[0]

# â”€â”€ ìœ„ì ¯ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def img_button(hand, cb, sz=120):
    img = w.Image(value=IMG_BYTES[hand], format='png', width=sz, height=sz)
    btn = w.Button(description=hand, layout=w.Layout(width=f'{sz}px'))
    btn.on_click(lambda _, h=hand: cb(h))
    return w.VBox([img, btn])

def img_row(title, hands, sz=100):
    return w.VBox([w.Label(title),
                   w.HBox([w.Image(value=IMG_BYTES[h], format='png',
                                   width=sz, height=sz) for h in hands])])

# â”€â”€ ê²Œì„ ë¡œì§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class RPSGame:
    def __init__(self, diff, host, back_to_menu):
        self.diff, self.host, self.back = diff, host, back_to_menu
        self.start_round()

    def start_round(self, *_):
        self.player_two, self.comp_two = [], []
        self.host.children = [w.VBox([
            w.Label(f'ë‚œì´ë„: {self.diff}  |  1ë‹¨ê³„: ë‘ ì¥ì„ ê³ ë¥´ì„¸ìš”'),
            w.HBox([img_button(h, self.pick_two) for h in IMG_BYTES],
                   layout=w.Layout(justify_content='center'))
        ])]

    def pick_two(self, h):
        if h in self.player_two or len(self.player_two) == 2: return
        self.player_two.append(h)
        if len(self.player_two) == 2:
            self.comp_two = random.choice([C1, C2, C3])
            self.show_second()

    def show_second(self):
        self.host.children = [w.VBox([
            w.Label('ì»´í“¨í„°ê°€ ê³ ë¥¸ ë‘ ì¥ì…ë‹ˆë‹¤. í•œ ì¥ë§Œ ë‚¨ê¸°ì„¸ìš”.'),
            img_row('ì»´í“¨í„°ì˜ íŒ¨', self.comp_two),
            w.HBox([img_button(h, self.pick_final) for h in self.player_two],
                   layout=w.Layout(justify_content='center'))
        ])]

    def pick_final(self, h):
        self.player_final = h
        self.comp_final = (random.choice(self.comp_two) if self.diff == 'ë³´í†µ'
                           else choose_hard(self.comp_two, self.player_two))
        self.show_result()

    def show_result(self):
        outcome = self.judge(self.player_final, self.comp_final)
        txt = {'win':'ìŠ¹ë¦¬ ğŸ‰','lose':'íŒ¨ë°° ğŸ˜¢','draw':'ë¬´ìŠ¹ë¶€ ğŸ¤'}[outcome]

        again = w.Button(description='ë‹¤ì‹œ ì‹œì‘í•˜ê¸° ğŸ”„')
        again.on_click(self.start_round)      # â† ì—¬ê¸°ì„œ ì½œë°± ë“±ë¡

        diff  = w.Button(description='ë‚œì´ë„ ë³€ê²½')
        diff.on_click(lambda _ : self.back()) # â† ì—¬ê¸°ì„œ ì½œë°± ë“±ë¡

        self.host.children = [w.VBox([
            img_row('ì»´í“¨í„°ì˜ íŒ¨', [self.comp_final]),
            img_row('ë‹¹ì‹ ì˜ íŒ¨',   [self.player_final]),
            w.Label(f'ê²°ê³¼: {txt}'),
            w.HBox([again, diff])
        ])]


    @staticmethod
    def judge(p, c):
        if p == c: return 'draw'
        beats = {'ê°€ìœ„':'ë³´','ë°”ìœ„':'ê°€ìœ„','ë³´':'ë°”ìœ„'}
        return 'win' if beats[p] == c else 'lose'

# â”€â”€ ì•± ë§¤ë‹ˆì € â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class RPSApp:
    def __init__(self):
        self.root = w.VBox()
        display(self.root)
        self.menu()

    def menu(self):
        diff_dd  = w.Dropdown(options=['ë³´í†µ','ì–´ë ¤ì›€'], value='ë³´í†µ', description='ë‚œì´ë„:')
        start_btn= w.Button(description='ê²Œì„ ì‹œì‘ â–¶')
        self.root.children = [w.VBox([diff_dd, start_btn])]
        def start(_):
            self.root.children = []
            RPSGame(diff_dd.value, self.root, self.menu)
        start_btn.on_click(start)

# â”€â”€ ì‹¤í–‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
game = RPSApp()
